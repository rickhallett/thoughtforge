// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Database Indices
model IndexConfig {
  name           String   @id
  lastUpdateTime DateTime @default(now())
  
  @@map("_index_config")
}

// Enums
enum ContentStatus {
  NEW
  PROCESSING
  ENHANCED
  APPROVED
  SCHEDULED
  PUBLISHED
  FAILED
}

enum ProcessingStage {
  STANDARDIZATION
  AI_ENHANCEMENT
  SEO_ENHANCEMENT
  APPROVAL
  PUBLISHING
}

enum UserRole {
  ADMIN
  EDITOR
  USER
}

enum DestinationType {
  BLOG
  SOCIAL_MEDIA
  NEWSLETTER
  OTHER
}

enum LogLevel {
  INFO
  WARN
  ERROR
}

// Models
model User {
  id        String    @id @default(uuid())
  name      String    @db.VarChar(100)
  email     String    @unique @db.VarChar(255)
  password  String    @db.VarChar(255) // Stored as hashed value
  role      UserRole
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  isArchived Boolean  @default(false)
  version   Int       @default(1)

  // Relations
  approvals Content[] @relation("ApproverContents")

  @@index([email])
  @@index([role])
  @@index([deletedAt])
}

model OriginalSource {
  id          String    @id @default(uuid())
  sourceType  String    @db.VarChar(50) // e.g., 'markdown', 'web_clipping', 'voice_note'
  title       String?   @db.VarChar(255)
  content     String    @db.Text
  focusPoints String?   @db.Text // Stored as JSON string or separate model if needed
  tags        String[] 
  submittedAt DateTime  @default(now())
  queryParams Json      @db.JsonB // Stores optional query parameters
  metadata    Json      @db.JsonB // Additional metadata if needed
  deletedAt   DateTime?
  version     Int       @default(1)

  // Relations
  contents    Content[]

  @@index([sourceType])
  @@index([submittedAt])
  @@index([deletedAt])
}

model Content {
  id               String        @id @default(uuid())
  originalSourceId String
  currentStatus    ContentStatus @default(NEW)
  content          String?       @db.Text
  metadata         Json          @db.JsonB // Stores additional data like AI outputs
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?
  version          Int          @default(1)
  isArchived       Boolean      @default(false)

  // Relations
  originalSource   OriginalSource    @relation(fields: [originalSourceId], references: [id])
  processingLogs   ProcessingLog[]
  errorLogs        ErrorLog[]
  publishingQueues PublishingQueue[]
  tags             ContentTag[]
  approverId       String?
  approver         User?             @relation("ApproverContents", fields: [approverId], references: [id])

  @@index([currentStatus])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([originalSourceId])
  @@index([approverId])
}

model ProcessingLog {
  id          String          @id @default(uuid())
  contentId   String
  stage       ProcessingStage
  status      ContentStatus   @default(PROCESSING)
  startedAt   DateTime        @default(now())
  completedAt DateTime?
  details     Json           @db.JsonB // Any details or outputs from the processing stage
  version     Int           @default(1)

  // Relations
  content   Content    @relation(fields: [contentId], references: [id])
  errorLogs ErrorLog[]

  @@index([contentId])
  @@index([stage])
  @@index([status])
  @@index([startedAt])
}

model PublishingQueue {
  id                String        @id @default(uuid())
  contentId         String
  scheduledAt       DateTime
  actualPublishedAt DateTime?
  status            ContentStatus @default(SCHEDULED)
  metadata          Json // Additional data like publishing results

  // Relations
  content      Content            @relation(fields: [contentId], references: [id])
  destinations QueueDestination[]
  errorLogs    ErrorLog[]
}

model QueueDestination {
  id                String @id @default(uuid())
  publishingQueueId String
  destinationId     String

  // Relations
  publishingQueue PublishingQueue       @relation(fields: [publishingQueueId], references: [id])
  destination     PublishingDestination @relation(fields: [destinationId], references: [id])
}

model PublishingDestination {
  id        String          @id @default(uuid())
  name      String
  type      DestinationType
  config    Json // Stores credentials or connection info securely
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  // Relations
  queueDestinations QueueDestination[]
}

model ErrorLog {
  id                String   @id @default(uuid())
  contentId         String?
  processingLogId   String?
  publishingQueueId String?
  timestamp         DateTime @default(now())
  message           String
  level             LogLevel @default(ERROR)
  metadata          Json // Additional error details

  // Relations
  content         Content?         @relation(fields: [contentId], references: [id])
  processingLog   ProcessingLog?   @relation(fields: [processingLogId], references: [id])
  publishingQueue PublishingQueue? @relation(fields: [publishingQueueId], references: [id])
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contentTags ContentTag[]
}

model ContentTag {
  contentId String
  tagId     String

  // Relations
  content Content @relation(fields: [contentId], references: [id])
  tag     Tag     @relation(fields: [tagId], references: [id])

  @@id([contentId, tagId])
}
